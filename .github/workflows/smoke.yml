name: Smoke CI

on:
  pull_request:
  push:
    branches:
      - main
      - migration/**
  workflow_dispatch:
    inputs:
      enable_hub_sync:
        description: Check out ecosystem-content-hub and run content sync before build
        required: false
        default: false
        type: boolean
      hub_repo:
        description: ecosystem-content-hub repository (owner/name)
        required: false
        default: semio-community/ecosystem-content-hub
        type: string
      hub_ref:
        description: ecosystem-content-hub ref to test (branch/tag/SHA)
        required: false
        default: main
        type: string
      fail_on_dirty:
        description: Fail when sync/generation leaves uncommitted changes
        required: false
        default: true
        type: boolean

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout site repo
        uses: actions/checkout@v4
        with:
          path: site

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: site/package-lock.json

      - name: Install dependencies
        working-directory: site
        run: npm ci

      - name: Resolve hub owner
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.enable_hub_sync }}
        id: hub_owner
        env:
          HUB_REPO: ${{ inputs.hub_repo }}
        run: echo "owner=${HUB_REPO%%/*}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub App token
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.enable_hub_sync }}
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.SEMIO_GH_APP_ID }}
          private-key: ${{ secrets.SEMIO_GH_APP_PRIVATE_KEY }}
          owner: ${{ steps.hub_owner.outputs.owner }}

      - name: Checkout content hub
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.enable_hub_sync }}
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.hub_repo }}
          ref: ${{ inputs.hub_ref }}
          path: semio-content-hub
          token: ${{ steps.app_token.outputs.token }}

      - name: Sync content from hub
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.enable_hub_sync }}
        working-directory: site
        run: npm run content:sync:all

      - name: Generate CMS config
        working-directory: site
        run: npm run cms:config

      - name: Build site
        working-directory: site
        run: npm run build:site

      - name: Verify clean working tree
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.fail_on_dirty }}
        working-directory: site
        run: git diff --exit-code
