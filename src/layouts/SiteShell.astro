---
import Footer from "@/components/layout/Footer";
import Header from "@/components/layout/Header";
import SkipLink from "@/components/layout/SkipLink";
import ParallaxHexBackground from "@/components/background/ParallaxHexBackground";
import ThemeProvider from "@/components/theme/ThemeProvider";
import { getCollection } from "astro:content";
import {
  menuLinks,
  type FeaturedSection,
  type NavCollections,
} from "@/site.config";
import { isDraftVisible } from "@/utils/drafts";

export interface Props {
  noPaddingTop?: boolean;
  showBackground?: boolean;
  containerClassName?: string;
  backgroundCount?: number;
  backgroundSeed?: string | number;
  backgroundVerticalSpanVh?: number;
  backgroundHorizontalRangeVw?: { min: number; max: number };
  backgroundPalette?: string[];
  backgroundOpacity?: { stroke: [number, number]; fill: [number, number] };
  backgroundClassName?: string;
}

const {
  noPaddingTop = false,
  showBackground = true,
  containerClassName,
  backgroundCount,
  backgroundSeed,
  backgroundVerticalSpanVh,
  backgroundHorizontalRangeVw,
  backgroundPalette,
  backgroundOpacity,
  backgroundClassName,
} = Astro.props;

const coerceFieldValue = (value: unknown): string | number | undefined => {
  if (typeof value === "string" || typeof value === "number") return value;
  if (value instanceof Date && !Number.isNaN(value.getTime())) {
    return value.getFullYear();
  }
  return undefined;
};

const featuredSections = menuLinks
  .flatMap((link) => link.sections ?? [])
  .filter((section): section is FeaturedSection => section.kind === "featured");

const idsByCollection = new Map<FeaturedSection["collection"], Set<string>>();
const fieldsByCollection = new Map<
  FeaturedSection["collection"],
  Set<string>
>();

for (const section of featuredSections) {
  if (!idsByCollection.has(section.collection)) {
    idsByCollection.set(section.collection, new Set());
  }
  if (!fieldsByCollection.has(section.collection)) {
    fieldsByCollection.set(section.collection, new Set());
  }

  const ids = idsByCollection.get(section.collection)!;
  const fields = fieldsByCollection.get(section.collection)!;
  for (const itemId of section.items) ids.add(itemId);
  fields.add(section.fields.title);
  if (section.fields.subtitle) fields.add(section.fields.subtitle);
}

const navCollections: NavCollections = {};
for (const [collection, ids] of idsByCollection) {
  if (ids.size === 0) continue;
  const entries = await getCollection(collection, ({ data }) =>
    isDraftVisible((data as { draft?: boolean }).draft),
  );
  const fields = fieldsByCollection.get(collection) ?? new Set();
  const collectionMap: Record<
    string,
    { id: string; fields: Record<string, string | number | undefined> }
  > = {};

  for (const entry of entries) {
    if (!ids.has(entry.id)) continue;
    const fieldValues: Record<string, string | number | undefined> = {};
    for (const fieldName of fields) {
      const rawValue = (entry.data as Record<string, unknown>)[fieldName];
      const value = coerceFieldValue(rawValue);
      if (value !== undefined) fieldValues[fieldName] = value;
    }
    collectionMap[entry.id] = { id: entry.id, fields: fieldValues };
  }

  navCollections[collection] = collectionMap;
}
---

<ThemeProvider />
<SkipLink />
<Header
  client:load
  currentPath={Astro.url.pathname}
  navCollections={navCollections}
/>

{
  showBackground && (
    <ParallaxHexBackground
      client:only="react"
      count={backgroundCount}
      seed={backgroundSeed}
      verticalSpanVh={backgroundVerticalSpanVh}
      horizontalRangeVw={backgroundHorizontalRangeVw}
      palette={backgroundPalette}
      opacity={backgroundOpacity}
      className={backgroundClassName}
    />
  )
}

<div class="relative flex min-h-screen w-full flex-col">
  <div class="relative flex min-h-screen w-full flex-1 m-auto max-w-6xl">
    <div
      id="container"
      class={`relative m-auto max-w-4xl grow w-full min-w-0 ${containerClassName || ""}`}
    >
      <div
        class={`m-auto grid grid-cols-1 min-h-screen grid-rows-[1fr_auto] px-4 md:px-8 w-full min-w-0 ${noPaddingTop ? "" : "pt-[72px] lg:pt-4"}`}
      >
        <main id="main" class="relative grow" data-pagefind-body>
          <slot />
        </main>
        <Footer />
      </div>
    </div>
  </div>
</div>
