---
import { getEntry } from "astro:content";
import { PersonPopover } from "./PersonPopover";
import { getPerson } from "@/data/people";

interface Props {
  personId: string;
  role?: string;
}

const { personId, role } = Astro.props;
const personEntry = await getPerson(personId);

const person =
  personEntry && personEntry.data
    ? {
        id: personEntry.id,
        ...personEntry.data,
      }
    : null;

// Get current affiliation details if available
let currentAffiliation:
  | { partnerId: string; partnerName?: string; role: string }
  | undefined;
if (person?.affiliations) {
  const current = person.affiliations.find((a) => a.current);
  if (current) {
    const organization = await getEntry("organizations", current.partnerId);
    currentAffiliation = {
      partnerId: current.partnerId,
      partnerName: organization?.data.name || current.partnerId,
      role: current.role,
    };
  }
}
---

<PersonPopover
  client:load
  person={person}
  personId={personId}
  role={role}
  currentAffiliation={currentAffiliation}
/>
