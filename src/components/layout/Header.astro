---
import Search from "@/components/navigation/Search.astro";
import ThemeToggle from "@/components/theme/ThemeToggle.astro";
import { NavigationMenuComponent } from "@/components/navigation/NavigationMenu.tsx";
import { MobileNavigation } from "@/components/navigation/MobileNavigation.tsx";
import { siteConfig, menuLinks } from "@/site.config";
import { homeUrl, url } from "@/utils/url";
import { getAllHardware } from "@/data/hardware";
import { getAllSoftware } from "@/data/software";
import { getFeaturedResearch } from "@/data/research";

// Fetch data for navigation and simplify for React component
const allHardware = await getAllHardware();
const featuredResearch = await getFeaturedResearch();
const allSoftware = await getAllSoftware();

// Simplify data for serialization to React component
const hardwareItems = allHardware.map((item) => ({
  id: item.id,
  name: item.data.name,
  shortDescription: item.data.shortDescription,
  status: item.data.status,
}));

// Simplify software data for React component
const softwareItems = allSoftware.map((sw) => ({
  id: sw.id,
  name: sw.data.name,
  shortDescription: sw.data.shortDescription,
  status: sw.data.status,
}));

// Simplify research data for React component
const researchItems = featuredResearch.map((entry) => {
  const publishDate = entry.data.publishDate
    ? new Date(entry.data.publishDate)
    : null;
  const year =
    publishDate && !Number.isNaN(publishDate.getTime())
      ? publishDate.getFullYear()
      : (entry.data as { year?: number }).year;

  return {
    id: entry.id,
    title: entry.data.title,
    type: entry.data.type,
    year,
  };
});

// Define menu sections
const menuSections = {
  "/projects/": [
    { title: "Hardware Projects", href: "/projects/#hardware" },
    { title: "Software Projects", href: "/projects/#software" },
    { title: "Research Projects", href: "/projects/#research" },
    { title: "Contribute", href: "/projects/#contribute" },
  ],
  "/services/": [
    { title: "Hardware Services", href: "/services/#hardware-services" },
    { title: "Software Services", href: "/services/#software-services" },
    { title: "Research Services", href: "/services/#research-services" },
    { title: "Get Started", href: "/services/#get-started" },
  ],

  "/events/": [
    { title: "Upcoming Events", href: "/events/#upcoming" },
    { title: "Past Events", href: "/events/#past" },
    { title: "Host an Event", href: "/events/#host" },
  ],
  "/partners/": [
    { title: "Current Partners", href: "/partners/#current" },
    { title: "Become a Partner", href: "/partners/#become" },
    { title: "Benefits", href: "/partners/#benefits" },
  ],
  "/get-involved/": [
    { title: "Contribute", href: "/get-involved/#contribute" },
    { title: "Donate", href: "/get-involved/#donate" },
    { title: "Volunteer", href: "/get-involved/#volunteer" },
    { title: "Join Community", href: "/get-involved/#community" },
  ],
};
---

<style>
  @import "@/components/navigation/navigation-menu.css";
  /* Keep site-search mounted on mobile but hide its open button */
  .hide-search-trigger [data-open-modal] {
    display: none;
  }
  @media (min-width: 768px) {
    .hide-search-trigger [data-open-modal] {
      display: flex;
    }
  }
</style>

<header
  id="main-header"
  class="fixed left-0 right-0 z-50 lg:sticky top-0 h-16 w-full bg-surface/80 backdrop-blur-xl lg:bg-surface/85 lg:backdrop-blur-lg border-b border-accent-base/10 shadow-[0_2px_8px_-3px_rgba(0,0,0,0.07)] dark:shadow-[0_2px_8px_-3px_rgba(0,0,0,0.3)]"
>
  <!-- Background
			TODO: This approach is not optimal and requires improvements.
  			- Too many absolutely positioned elements can affect performance.
  		-->
  <div
    class="md:hidden absolute top-0 left-1/2 -ml-[50vw] w-screen min-h-screen pointer-events-none blur-2xl"
  >
    <div
      class="absolute top-[-90%] right-[25%] w-[75%] h-full bg-gradient-to-b from-orange-500 via-amber-400 to-transparent rounded-full opacity-40 dark:opacity-5"
    >
    </div>
    <div
      class="absolute top-[-90%] left-[25%] w-[75%] h-full bg-gradient-to-b from-amber-400 via-teal-400 to-transparent rounded-full opacity-40 dark:opacity-5"
    >
    </div>
    <div
      class="absolute top-[-85%] right-[25%] w-[55%] h-full bg-gradient-to-b from-teal-400 via-orange-500 to-transparent rounded-full opacity-40 dark:opacity-5"
    >
    </div>
    <div
      class="absolute top-[-85%] left-[25%] w-[55%] h-full bg-gradient-to-b from-orange-500 via-amber-400 to-transparent rounded-full opacity-40 dark:opacity-5"
    >
    </div>
    <div
      class="absolute top-[-75%] left-[-25%] w-[65%] h-full bg-gradient-to-b from-teal-400 via-amber-400 to-transparent rounded-full opacity-30 dark:opacity-5"
    >
    </div>
    <div
      class="absolute top-[-75%] right-[-25%] w-[65%] h-full bg-gradient-to-b from-amber-400 via-teal-400 to-transparent rounded-full opacity-30 dark:opacity-5"
    >
    </div>
    <div
      class="absolute top-[-85%] left-[-30%] w-[85%] h-full bg-gradient-to-b from-orange-500 via-teal-400 to-transparent rounded-full opacity-60 dark:opacity-5"
    >
    </div>
    <div
      class="absolute top-[-85%] right-[-30%] w-[85%] h-full bg-gradient-to-b from-teal-400 via-orange-500 to-transparent rounded-full opacity-60 dark:opacity-5"
    >
    </div>
  </div>

  <!-- Content container with max-width constraint -->
  <div
    class="w-full h-full xl:max-w-6xl xl:mx-auto px-2 sm:px-4 md:px-6 lg:px-8 flex items-center justify-between"
  >
    <!-- Logo section -->
    <a
      aria-label={siteConfig.title}
      aria-current={Astro.url.pathname === "/" ? "page" : false}
      class="group flex h-8 items-center hover:filter-none sm:relative"
      href={homeUrl()}
    >
      <!-- Logo -->
      <!--
				<div class="pt-1.5">
					<svg class="inline-block size-8 fill-current text-accent-base drop-shadow-[0px_2.5px_2.5px_rgba(0,0,0,0.35)]">
						<use href="/brand.svg#brand"></use>
					</svg>
				</div>
				-->
      <div title={siteConfig.title}>
        <svg
          class="inline-block size-5 fill-current text-accent-base dark:text-accent-two drop-shadow-[0px_2.5px_2.5px_rgba(0,0,0,0.15)]"
        >
          <use href={url("brand.svg#brand")}></use>
        </svg>
      </div>

      <strong
        class="'max-[320px]:hidden' lowercase text-base hidden lg:block z-10 mb-0.5 ms-2 lg:text-base xl:text-lg hover:opacity-90 whitespace-nowrap"
      >
        {siteConfig.title}
      </strong>
    </a>

    <!-- Desktop Navigation with Radix UI -->
    <nav class="hidden md:flex ml-auto mr-2 lg:mr-6 items-center">
      <NavigationMenuComponent
        client:load
        currentPath={Astro.url.pathname}
        menuLinks={menuLinks}
        hardwareItems={hardwareItems}
        softwareItems={softwareItems}
        researchItems={researchItems}
        menuSections={menuSections}
        urlPrefix=""
      />
    </nav>

    <!-- Right side buttons and mobile menu -->
    <div class="flex items-center gap-x-1 md:gap-x-2">
      <div id="buttons-panel" class="flex space-x-1 md:space-x-2">
        <div class="hide-search-trigger">
          <Search />
        </div>
        <div class="hidden md:block">
          <ThemeToggle />
        </div>
      </div>

      <!-- Mobile Navigation with Radix UI Dialog -->
      <div class="md:hidden">
        <MobileNavigation
          client:load
          menuLinks={menuLinks}
          currentPath={Astro.url.pathname}
          urlPrefix=""
        />
      </div>
    </div>
  </div>
</header>
