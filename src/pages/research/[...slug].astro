---
import {
  type CollectionEntry,
  getCollection,
  render,
  getEntry,
} from "astro:content";
import PageLayout from "@/layouts/Base.astro";
import BaseDetailLayout from "@/components/detail/BaseDetailLayout.astro";
import { DetailHero } from "@/components/detail/DetailHero";
import { RelatedItemsGrid } from "@/components/detail/RelatedItemsGrid";
import InfoCard from "@/components/detail/InfoCard.astro";
import LinkButton from "@/components/detail/LinkButton.astro";
import { getAllResearch } from "@/data/research";
import { getPerson, getFormattedAuthors } from "@/data/people";
import PersonPopoverWrapper from "@/components/people/PersonPopoverWrapper.astro";
import OrganizationChip from "@/components/ui/OrganizationChip.astro";
import { Fragment } from "react";
import { transformLinksToButtons } from "@/config/linkConfig";
import HardwareCard from "@/components/cards/HardwareCard.astro";
import SoftwareCard from "@/components/cards/SoftwareCard.astro";

export async function getStaticPaths() {
  const researchEntries = await getCollection("research", ({ data }) => {
    // In production, exclude drafts. In development, show all.
    return import.meta.env.PROD ? data.draft !== true : true;
  });
  return researchEntries.map((entry) => ({
    params: { slug: entry.id },
    props: { entry },
  }));
}

type Props = {
  entry: CollectionEntry<"research">;
};

const { entry } = Astro.props;
const { Content } = await render(entry);
const { data } = entry;

// Get related research entries (by keywords or research areas)
async function getRelatedResearch(
  researchEntry: CollectionEntry<"research">,
  limit: number = 3,
) {
  const allResearch = await getAllResearch();
  const relatedResearch: CollectionEntry<"research">[] = [];

  // Filter out the current entry
  const otherEntries = allResearch.filter((item) => item.id !== researchEntry.id);

  // Score each entry based on similarity
  const scoredEntries = otherEntries.map((item) => {
    let score = 0;

    // Same type gets points
    if (item.data.type === researchEntry.data.type) score += 2;

    // Same venue gets points
    if (item.data.venue && item.data.venue === researchEntry.data.venue) score += 3;

    // Close year gets points (within 2 years)
    const yearDiff = Math.abs(item.data.year - researchEntry.data.year);
    if (yearDiff <= 2) score += 3 - yearDiff;

    // Overlapping keywords get points
    const entryKeywords = new Set(researchEntry.data.keywords || []);
    const otherKeywords = item.data.keywords || [];
    const keywordOverlap = otherKeywords.filter((kw) =>
      entryKeywords.has(kw),
    ).length;
    score += keywordOverlap * 2;

    // Overlapping research areas get points
    const entryAreas = new Set(researchEntry.data.researchArea || []);
    const otherAreas = item.data.researchArea || [];
    const areaOverlap = otherAreas.filter((area) =>
      entryAreas.has(area),
    ).length;
    score += areaOverlap * 2;

    // Shared authors get high points
    const entryAuthors = new Set(
      researchEntry.data.authors.map((author) => author.personId),
    );
    const otherAuthors = item.data.authors.map((author) => author.personId);
    const authorOverlap = otherAuthors.filter((id) =>
      entryAuthors.has(id),
    ).length;
    score += authorOverlap * 5;

    return { entry: item, score };
  });

  // Sort by score and take the top ones
  scoredEntries.sort((a, b) => b.score - a.score);

  return scoredEntries
    .filter((ss) => ss.score > 0)
    .slice(0, limit)
    .map((ss) => ss.entry);
}

const relatedResearch = await getRelatedResearch(entry, 3);

// Get formatted authors string
const authorsString = await getFormattedAuthors(data.authors);

const meta = {
  title: `${data.title} - Research Study`,
  description: data.abstract,
};

// Prepare status badges
const badges = [];

// Type badge
const typeLabels = {
  study: "Study",
  paper: "Research Paper",
  thesis: "Thesis",
  report: "Technical Report",
  preprint: "Preprint",
  dataset: "Dataset",
  benchmark: "Benchmark",
};
badges.push({
  text: typeLabels[data.type] || data.type,
  color: "blue" as const,
  variant: "solid" as const,
});

// Year badge
badges.push({
  text: data.year.toString(),
  color: "gray" as const,
  variant: "outline" as const,
});

if (data.featured) {
  badges.push({
    text: "Featured",
    color: "accent" as const,
    variant: "solid" as const,
  });
}

// Prepare link buttons using centralized configuration
const linkButtons = data.links ? transformLinksToButtons(data.links) : [];

// Get author details with PersonPopover
const authorsWithData = await Promise.all(
  data.authors.map(async (author) => {
    const person = await getPerson(author.personId);
    return {
      ...author,
      person: person?.data,
    };
  }),
);

// Sort by order
authorsWithData.sort((a, b) => a.order - b.order);

// Filter out authors where person data couldn't be found
const validAuthors = authorsWithData.filter((a) => a.person);

// Prepare publication details
const publicationItems = [];
if (data.venue) {
  publicationItems.push({
    label: "Venue",
    value: data.venue,
  });
}
publicationItems.push({
  label: "Year",
  value: data.year.toString(),
});
if (data.citations && data.citations > 0) {
  publicationItems.push({
    label: "Citations",
    value: data.citations.toString(),
  });
}
if (data.publishDate) {
  const pubDate = new Date(data.publishDate);
  const now = new Date();

  if (pubDate > now) {
    // Study is not yet published
    publicationItems.push({
      label: "Status",
      value: "Ongoing",
    });
  } else {
    // Study is published
    publicationItems.push({
      label: "Published",
      value: pubDate.toLocaleDateString("en-US", {
        month: "long",
        day: "numeric",
        year: "numeric",
      }),
    });
  }
} else {
  // No publish date means ongoing
  publicationItems.push({
    label: "Status",
    value: "Ongoing",
  });
}

// Get affiliated organizations
const affiliatedOrgs = await Promise.all(
  (data.affiliatedOrganizations || []).map((id) => getEntry("organizations", id)),
);
const validAffiliatedOrgs = affiliatedOrgs.filter((org) => org !== undefined);

// Get funding organizations
const fundingOrgs = await Promise.all(
  (data.fundingOrganizations || []).map((id) => getEntry("organizations", id)),
);
const validFundingOrgs = fundingOrgs.filter((org) => org !== undefined);

// Get related hardware
const relatedHardwareItems = data.relatedHardware
  ? await Promise.all(
      data.relatedHardware.map((id) => getEntry("hardware", id)),
    )
  : [];
const validRelatedHardware = relatedHardwareItems.filter(
  (item) => item !== undefined,
);

// Get related software
const relatedSoftwareItems = data.relatedSoftware
  ? await Promise.all(
      data.relatedSoftware.map((id) => getEntry("software", id)),
    )
  : [];
const validRelatedSoftware = relatedSoftwareItems.filter(
  (item) => item !== undefined,
);
---

<PageLayout meta={meta} noPaddingTop>
  <BaseDetailLayout>
    <Fragment slot="hero">
      <DetailHero
        client:load
        image={data.images?.hero}
        title={data.title}
        subtitle={authorsString}
        badges={badges}
        featured={data.featured}
        thumbnail={data.images?.logo}
        entityType="research"
      />
    </Fragment>

    {/* Description/Abstract */}
    <Fragment slot="description">
      <div class="abstract-section">
        <div
          class="bg-gradient-to-br from-surface-lighter to-surface rounded-xl border border-accent-one/20 p-6"
        >
          <h3
            class="text-xs font-semibold mb-3 text-accent-base uppercase tracking-wider"
          >
            SUMMARY
          </h3>
          <p class="text-accent-base">{data.abstract}</p>
        </div>
      </div>

      {/* External Links */}
      {
        linkButtons.length > 0 && (
          <div class="mt-6">
            <InfoCard title="LINKS & RESOURCES">
              <div class="flex flex-wrap gap-3">
                {linkButtons.map((button) => (
                  <LinkButton
                    href={button.href}
                    text={button.text}
                    icon={button.icon}
                    external={button.external}
                    variant={button.variant || "default"}
                  />
                ))}
              </div>
            </InfoCard>
          </div>
        )
      }
    </Fragment>

    {/* Contributors Section */}
    <Fragment slot="contributors">
      {/* Authors Section */}
      {
        validAuthors.length > 0 && (
          <div class="authors-section mb-8">
            <div class="bg-gradient-to-br from-surface-lighter to-surface rounded-xl border border-accent-one/20 p-6">
              <h3 class="text-xs font-semibold mb-3 text-accent-base uppercase tracking-wider">
                AUTHORS
              </h3>
              <div class="flex flex-wrap gap-2">
                {validAuthors.map((author) => (
                  <div class="flex items-center gap-1">
                    <PersonPopoverWrapper
                      personId={author.personId}
                      role={author.affiliationSnapshot}
                    />
                    {author.corresponding && (
                      <span
                        class="text-xs text-accent-one"
                        title="Corresponding Author"
                      >
                        âœ‰
                      </span>
                    )}
                    {author.equalContribution && (
                      <span
                        class="text-xs text-color-500"
                        title="Equal Contribution"
                      >
                        *
                      </span>
                    )}
                  </div>
                ))}
              </div>
            </div>
          </div>
        )
      }

      {/* Organizations Section */}
      {
        (validAffiliatedOrgs.length > 0 || validFundingOrgs.length > 0) && (
          <div class="organizations-section mb-8">
            <div class="bg-gradient-to-br from-surface-lighter to-surface rounded-xl border border-accent-one/20 p-6">
              <h3 class="text-xs font-semibold mb-3 text-accent-base uppercase tracking-wider">
                ORGANIZATIONS
              </h3>
              {validAffiliatedOrgs.length > 0 && (
                <div class="mb-4">
                  <h4 class="text-xs font-medium mb-2 text-color-600 dark:text-color-400">
                    Affiliated Institutions
                  </h4>
                  <div class="flex flex-wrap gap-2">
                    {validAffiliatedOrgs.map(
                      (org) =>
                        org && (
                          <OrganizationChip
                            partnerId={org.id}
                            role="Affiliated Institution"
                          />
                        ),
                    )}
                  </div>
                </div>
              )}
              {validFundingOrgs.length > 0 && (
                <div>
                  <h4 class="text-xs font-medium mb-2 text-color-600 dark:text-color-400">
                    Funding Organizations
                  </h4>
                  <div class="flex flex-wrap gap-2">
                    {validFundingOrgs.map(
                      (org) =>
                        org && (
                          <OrganizationChip
                            partnerId={org.id}
                            role="Funding Partner"
                          />
                        ),
                    )}
                  </div>
                </div>
              )}
            </div>
          </div>
        )
      }
    </Fragment>

    {/* Publication Details */}
    <Fragment slot="metadata">
      {
        publicationItems.length > 0 && (
          <div class="publication-details">
            <div class="bg-gradient-to-br from-surface-lighter to-surface rounded-xl border border-accent-one/20 p-6">
              <h3 class="text-xs font-semibold mb-3 text-accent-base uppercase tracking-wider">
                DETAILS
              </h3>
              <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                {publicationItems.map((item) => (
                  <div>
                    <span class="text-xs text-color-600 dark:text-color-400 font-semibold block mb-1">
                      {item.label}
                    </span>
                    <span class="text-accent-base">{item.value}</span>
                  </div>
                ))}
              </div>
            </div>
          </div>
        )
      }
    </Fragment>

    {/* Keywords and Research Areas */}
    <Fragment slot="tags">
      {
        (data.keywords?.length > 0 || data.researchArea?.length > 0) && (
          <div class="topics-section">
            <div class="bg-gradient-to-br from-surface-lighter to-surface rounded-xl border border-accent-one/20 p-6">
              <h3 class="text-xs font-semibold mb-3 text-accent-base uppercase tracking-wider">
                RESEARCH TOPICS
              </h3>

              {data.keywords && data.keywords.length > 0 && (
                <div class="mb-4">
                  <h4 class="text-xs font-medium mb-2 text-color-600 dark:text-color-400">
                    Keywords
                  </h4>
                  <div class="flex flex-wrap gap-2">
                    {data.keywords.map((keyword) => (
                      <span class="px-3 py-1.5 bg-accent-one/10 rounded-lg text-sm text-accent-base">
                        {keyword}
                      </span>
                    ))}
                  </div>
                </div>
              )}

              {data.researchArea && data.researchArea.length > 0 && (
                <div>
                  <h4 class="text-xs font-medium mb-2 text-color-600 dark:text-color-400">
                    Research Areas
                  </h4>
                  <div class="flex flex-wrap gap-2">
                    {data.researchArea.map((area) => (
                      <span class="px-3 py-1.5 bg-accent-two/10 rounded-lg text-sm text-accent-base">
                        {area}
                      </span>
                    ))}
                  </div>
                </div>
              )}
            </div>
          </div>
        )
      }
    </Fragment>

    {/* Main content from MDX file */}
    <!-- <Content /> -->

    {/* Related Items */}
    <Fragment slot="related">
      {/* Related Hardware */}
      {
        validRelatedHardware.length > 0 && (
          <div class="mb-12">
            <h3 class="text-lg font-semibold mb-4">Related Hardware</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {validRelatedHardware.map((hw) => (
                <HardwareCard hardwareId={hw.id} />
              ))}
            </div>
          </div>
        )
      }

      {/* Related Software */}
      {
        validRelatedSoftware.length > 0 && (
          <div class="mb-12">
            <h3 class="text-lg font-semibold mb-4">Related Software</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {validRelatedSoftware.map((sw) => (
                <SoftwareCard softwareId={sw.id} />
              ))}
            </div>
          </div>
        )
      }

      {/* Related Research */}
      {
        relatedResearch && relatedResearch.length > 0 && (
          <RelatedItemsGrid
            client:load
            title="Related Research"
            subtitle="Related papers, datasets, and benchmarks"
            items={
              relatedResearch.map((entry) => ({
                id: entry.id,
                data: {
                  name: entry.data.title,
                  title: entry.data.title,
                  displayName: undefined,
                  description: entry.data.abstract,
                  abstract: entry.data.abstract,
                  status: undefined,
                  type: entry.data.type,
                  category: undefined,
                  featured: entry.data.featured,
                  images: entry.data.images,
                  avatar: undefined,
                  logo: undefined,
                  thumbnail: undefined,
                  banner: undefined,
                  links: entry.data.links,
                  shortDescription: `${typeLabels[entry.data.type] || entry.data.type} â€¢ ${entry.data.year}`,
                },
              })) as any
            }
            itemType="research"
            columns={3}
          />
        )
      }
    </Fragment>
  </BaseDetailLayout>
</PageLayout>
