---
import { type CollectionEntry, getCollection, getEntry } from "astro:content";
import BaseHead from "@/components/BaseHead.astro";
import SiteShell from "@/layouts/SiteShell.astro";
import { getRelatedResearch as fetchRelatedResearch } from "@/data/research";
import { getPerson, getFormattedAuthors } from "@/data/people";
import {
  ResearchDetail,
  type OrganizationRole,
  type ResearchAuthor,
  type ResearchOrganizationLink,
} from "@/components/detail/views/ResearchDetail";

export async function getStaticPaths() {
  const researchEntries = await getCollection("research", ({ data }) => {
    // In production, exclude drafts. In development, show all.
    return import.meta.env.PROD ? data.draft !== true : true;
  });
  return researchEntries.map((entry) => ({
    params: { slug: entry.id },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { data } = entry;

const relatedResearch = await fetchRelatedResearch(entry, 3);

const authors = data.contributors ?? [];
const authorsString = await getFormattedAuthors(authors);

const meta = {
  title: `${data.title} - Research Study`,
  description: data.description,
};
const ogImage = `/og/research/${entry.id}.png`;

const authorsWithData: ResearchAuthor[] = await Promise.all(
  authors.map(async (contributor) => {
    const personEntry = await getPerson(contributor.personId);
    return {
      ...contributor,
      person: personEntry?.data ?? null,
    };
  }),
);

const validRoles: OrganizationRole[] = [
  "lead",
  "affiliated",
  "funding",
  "collaborator",
];
const organizationLinks: ResearchOrganizationLink[] = [];

for (const orgLink of data.organizations ?? []) {
  const role = orgLink.role as OrganizationRole;
  if (!role || !validRoles.includes(role)) continue;
  const organization = await getEntry("organizations", orgLink.organizationId);
  if (!organization) continue;
  organizationLinks.push({
    role,
    note: orgLink.note,
    organization,
  });
}

// Get related hardware
const relatedHardwareItems = data.relatedHardware
  ? await Promise.all(
      data.relatedHardware.map((id) => getEntry("hardware", id)),
    )
  : [];

// Get related software
const relatedSoftwareItems = data.relatedSoftware
  ? await Promise.all(
      data.relatedSoftware.map((id) => getEntry("software", id)),
    )
  : [];

const validRelatedHardware = relatedHardwareItems.filter(
  (item): item is CollectionEntry<"hardware"> => Boolean(item),
);

const validRelatedSoftware = relatedSoftwareItems.filter(
  (item): item is CollectionEntry<"software"> => Boolean(item),
);
---

<html
  class="overflow-x-hidden grid scroll-pt-[72px] scroll-smooth font-sans text-text text-xl md:text-base antialiased"
  lang="en"
>
  <head>
    <BaseHead
      title={meta.title}
      description={meta.description}
      ogImage={ogImage}
    />
  </head>
  <body class="relative min-h-screen w-full bg-surface">
    <SiteShell noPaddingTop showBackground containerClassName="max-w-5xl">
      <ResearchDetail
        data={data}
        authors={authorsWithData}
        authorsSubtitle={authorsString}
        organizationLinks={organizationLinks}
        relatedHardware={validRelatedHardware}
        relatedSoftware={validRelatedSoftware}
        relatedResearch={relatedResearch}
      />
    </SiteShell>
  </body>
</html>
