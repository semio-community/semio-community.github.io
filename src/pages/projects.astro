---
import PageLayout from "@/layouts/Base.astro";
import Section from "@/components/Section.astro";
import HardwareCard from "@/components/cards/HardwareCard.astro";
import SoftwareCard from "@/components/cards/SoftwareCard.astro";
import StudyCard from "@/components/cards/StudyCard.astro";
import CallToActionButton from "@/components/CallToActionButton.astro";
import { Icon } from "astro-icon/components";
import { getAllHardware, getHardwareCountByStatus } from "@/data/hardware";
import { getAllSoftware, getSoftwareCountByStatus } from "@/data/software";
import { getFormattedAuthors } from "@/data/people";
import { getAllStudies } from "@/data/studies";

const meta = {
  title: "Projects",
  description:
    "Explore community-driven robotics hardware platforms, open-source software tools, and reproducible research studies advancing human-robot interaction",
};

// Fetch hardware from content collections
const allHardware = await getAllHardware();

// Fetch software from content collections
const allSoftware = await getAllSoftware();

// Fetch studies data - handle empty collection gracefully
const allStudies = await getAllStudies();

// let featuredStudies = [];
// let studyStatistics = null;
// let featuredStudiesWithAuthors: any[] = [];

// try {
//   // Dynamically import to avoid build errors when collection is empty
//   const studiesModule = await import("@/data/studies");
//   featuredStudies = await studiesModule.getFeaturedStudies();
//   studyStatistics = await studiesModule.getStudyStatistics();

//   // Pre-fetch author names for featured studies
//   featuredStudiesWithAuthors = await Promise.all(
//     featuredStudies.slice(0, featuredStudies.length).map(async (study) => ({
//       ...study,
//       authorString: await getFormattedAuthors(study.data.authors, 1),
//     })),
//   );
// } catch (error) {
//   // Studies collection is empty or doesn't exist
//   console.log("Studies collection not available");
// }
---

<PageLayout meta={meta}>
  <!-- <h1 class="title mb-6">Projects</h1> -->

  <!-- Hero Section -->
  <Section id="projects-hero">
    <div class="max-w-4xl mx-auto text-center mb-12">
      <p class="text-lg mb-8 text-color-600 dark:text-color-400">
        Discover and contribute to our growing ecosystem of community-driven
        robotics hardware, software, and research studies.
      </p>
      <div class="flex flex-wrap justify-center gap-4 mb-8">
        <CallToActionButton
          href="#hardware"
          text="Hardware Projects"
          size="large"
          indicatorText={allHardware.length?.toString()}
        />
        <CallToActionButton
          href="#software"
          text="Software Projects"
          size="large"
          variant="secondary"
          indicatorText={allSoftware.length?.toString()}
        />
        <CallToActionButton
          href="#studies"
          text="Research Projects"
          size="large"
          variant="tertiary"
          indicatorText={allStudies.length?.toString()}
        />
      </div>
    </div>
  </Section>

  <!-- Hardware Section -->
  <Section
    id="hardware"
    title="Hardware Projects"
    subtitle="Open-source robotics hardware for research and education"
  >
    <div class="max-w-6xl mx-auto">
      {
        allHardware.length > 0 ? (
          <div data-expandable-section data-initial-count="6">
            <div
              class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
              data-items-container
            >
              {allHardware.map((hw, index) => (
                <div
                  data-expandable-item
                  data-index={index}
                  class={index >= 6 ? "hidden" : ""}
                >
                  <HardwareCard hardwareId={hw.id} />
                </div>
              ))}
            </div>
            {allHardware.length > 6 && (
              <div class="text-center mt-8">
                <button
                  data-expand-button
                  class="inline-flex items-center gap-2 px-6 py-3 bg-accent-base/10 hover:bg-accent-base/20 rounded-lg font-medium text-accent-base transition-all"
                >
                  <span data-expand-text>
                    View All {allHardware.length} Platforms
                  </span>
                  <span data-collapse-text class="hidden">
                    Show Less
                  </span>
                  <Icon
                    name="solar:alt-arrow-down-line-duotone"
                    class="w-4 h-4 transition-transform"
                    data-expand-icon
                  />
                </button>
              </div>
            )}
          </div>
        ) : (
          <div class="text-center py-12">
            <Icon
              name="solar:box-minimalistic-line-duotone"
              class="w-24 h-24 mx-auto mb-4 text-color-300"
            />
            <p class="text-lg text-color-600 dark:text-color-400">
              Hardware platforms coming soon! Check back later for updates.
            </p>
          </div>
        )
      }
    </div>
  </Section>

  <!-- Software Section -->
  <Section
    id="software"
    title="Software Projects"
    subtitle="Comprehensive tools for every aspect of HRI development"
  >
    <div class="max-w-6xl mx-auto">
      {
        allSoftware.length > 0 ? (
          <div data-expandable-section data-initial-count="6">
            <div
              class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
              data-items-container
            >
              {allSoftware.map((sw, index) => (
                <div
                  data-expandable-item
                  data-index={index}
                  class={index >= 6 ? "hidden" : ""}
                >
                  <SoftwareCard softwareId={sw.id} />
                </div>
              ))}
            </div>
            {allSoftware.length > 6 && (
              <div class="text-center mt-8">
                <button
                  data-expand-button
                  class="inline-flex items-center gap-2 px-6 py-3 bg-accent-base/10 hover:bg-accent-base/20 rounded-lg font-medium text-accent-base transition-all"
                >
                  <span data-expand-text>
                    View All {allSoftware.length} Tools
                  </span>
                  <span data-collapse-text class="hidden">
                    Show Less
                  </span>
                  <Icon
                    name="solar:alt-arrow-down-line-duotone"
                    class="w-4 h-4 transition-transform"
                    data-expand-icon
                  />
                </button>
              </div>
            )}
          </div>
        ) : (
          <div class="text-center py-12">
            <Icon
              name="solar:code-2-line-duotone"
              class="w-24 h-24 mx-auto mb-4 text-color-300"
            />
            <p class="text-lg text-color-600 dark:text-color-400">
              Software packages coming soon! Check back later for updates.
            </p>
          </div>
        )
      }
    </div>
  </Section>

  <!-- Studies Section -->
  <Section
    id="studies"
    title="Research Projects"
    subtitle="Reproducible human-robot interaction research advancing the field"
  >
    <div class="max-w-6xl mx-auto">
      {
        allStudies.length > 0 ? (
          <div data-expandable-section data-initial-count="6">
            <div
              class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
              data-items-container
            >
              {allStudies.map((st, index) => (
                <div
                  data-expandable-item
                  data-index={index}
                  class={index >= 6 ? "hidden" : ""}
                >
                  <StudyCard studyId={st.id} />
                </div>
              ))}
            </div>
            {allStudies.length > 6 && (
              <div class="text-center mt-8">
                <button
                  data-expand-button
                  class="inline-flex items-center gap-2 px-6 py-3 bg-accent-base/10 hover:bg-accent-base/20 rounded-lg font-medium text-accent-base transition-all"
                >
                  <span data-expand-text>
                    View All {allStudies.length} Tools
                  </span>
                  <span data-collapse-text class="hidden">
                    Show Less
                  </span>
                  <Icon
                    name="solar:alt-arrow-down-line-duotone"
                    class="w-4 h-4 transition-transform"
                    data-expand-icon
                  />
                </button>
              </div>
            )}
          </div>
        ) : (
          <div class="text-center py-12">
            <Icon
              name="solar:code-2-line-duotone"
              class="w-24 h-24 mx-auto mb-4 text-color-300"
            />
            <p class="text-lg text-color-600 dark:text-color-400">
              Research studies coming soon! Check back later for updates.
            </p>
          </div>
        )
      }
    </div>
  </Section>
</PageLayout>

<script>
  // Handle expandable sections
  document.addEventListener("DOMContentLoaded", () => {
    const expandableSections = document.querySelectorAll(
      "[data-expandable-section]",
    );

    expandableSections.forEach((section) => {
      const button = section.querySelector("[data-expand-button]");
      const items = section.querySelectorAll("[data-expandable-item]");
      const expandText = section.querySelector("[data-expand-text]");
      const collapseText = section.querySelector("[data-collapse-text]");
      const icon = section.querySelector("[data-expand-icon]");
      const initialCount = parseInt(
        (section as HTMLElement).dataset.initialCount || "6",
      );

      if (!button || items.length <= initialCount) {
        // Hide button if not needed
        if (button) (button as HTMLElement).style.display = "none";
        return;
      }

      let isExpanded = false;

      button.addEventListener("click", () => {
        isExpanded = !isExpanded;

        items.forEach((item, index) => {
          if (index >= initialCount) {
            if (isExpanded) {
              item.classList.remove("hidden");
            } else {
              item.classList.add("hidden");
            }
          }
        });

        // Toggle button text
        if (expandText && collapseText) {
          if (isExpanded) {
            expandText.classList.add("hidden");
            collapseText.classList.remove("hidden");
          } else {
            expandText.classList.remove("hidden");
            collapseText.classList.add("hidden");
          }
        }

        // Rotate icon
        if (icon) {
          if (isExpanded) {
            (icon as HTMLElement).style.transform = "rotate(180deg)";
          } else {
            (icon as HTMLElement).style.transform = "rotate(0deg)";
          }
        }

        // Smooth scroll to section if collapsing
        if (!isExpanded) {
          const sectionTop =
            section.getBoundingClientRect().top + window.scrollY - 100;
          window.scrollTo({
            top: sectionTop,
            behavior: "smooth",
          });
        }
      });
    });
  });
</script>
