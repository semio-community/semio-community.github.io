---
import PageLayout from "@/layouts/Base.astro";
import Section from "@/components/Section.astro";
import FeatureCard from "@/components/FeatureCard.astro";
import { Icon } from "astro-icon/components";
import {
  getAllStudies,
  getStudyCountByType,
  getStudyCountByResearchArea,
  getUniqueResearchAreas,
  getFeaturedStudies,
  getMostCitedStudies,
  getRecentStudies,
  getStudyStatistics,
} from "@/data/studies";

const meta = {
  title: "Studies",
  description:
    "Reproducible human-robot interaction studies and research infrastructure for the HRI community",
};

// Fetch studies data from content collections
const allStudies = await getAllStudies();
const featuredStudies = await getFeaturedStudies();
const mostCitedStudies = await getMostCitedStudies(5);
const recentStudies = await getRecentStudies(5);
const studyTypeCount = await getStudyCountByType();
const researchAreaCount = await getStudyCountByResearchArea();
const researchAreas = await getUniqueResearchAreas();
const statistics = await getStudyStatistics();

const services = [
  {
    icon: "hugeicons:user-group",
    title: "Populations",
    description: "Access diverse participant pools for HRI research",
    features: [
      "Diverse demographics",
      "Special populations",
      "Remote participants",
      "In-person studies",
    ],
  },
  {
    icon: "solar:test-tube-line-duotone",
    title: "Studies",
    description: "Standardized study protocols and experimental designs",
    features: [
      "Pre-registered studies",
      "Reproducible protocols",
      "Multi-site studies",
      "Longitudinal research",
    ],
  },
  {
    icon: "solar:chart-2-line-duotone",
    title: "Analysis",
    description: "Statistical analysis and data processing pipelines",
    features: [
      "Standardized metrics",
      "Statistical tools",
      "Data visualization",
      "Open datasets",
    ],
  },
];

const studyTypeInfo: Record<
  string,
  { title: string; icon: string; description: string }
> = {
  paper: {
    title: "Research Papers",
    icon: "solar:document-text-line-duotone",
    description: "Peer-reviewed journal and conference papers",
  },
  dataset: {
    title: "Datasets",
    icon: "solar:database-line-duotone",
    description: "Curated data collections for HRI research",
  },
  thesis: {
    title: "Theses",
    icon: "solar:diploma-line-duotone",
    description: "Doctoral and master's dissertations",
  },
  report: {
    title: "Technical Reports",
    icon: "solar:file-text-line-duotone",
    description: "Technical reports and white papers",
  },
  preprint: {
    title: "Preprints",
    icon: "solar:document-line-duotone",
    description: "Pre-publication research manuscripts",
  },
  benchmark: {
    title: "Benchmarks",
    icon: "solar:chart-square-line-duotone",
    description: "Evaluation benchmarks and metrics",
  },
};

const benefits = [
  {
    icon: "solar:verified-check-line-duotone",
    title: "Reproducible Science",
    description:
      "Pre-registered protocols and open data ensure reproducibility",
  },
  {
    icon: "solar:users-group-two-rounded-line-duotone",
    title: "Collaborative Research",
    description: "Pool resources and expertise across institutions",
  },
  {
    icon: "solar:database-line-duotone",
    title: "Shared Data",
    description: "Build on existing datasets and contribute your own",
  },
  {
    icon: "solar:diploma-line-duotone",
    title: "Best Practices",
    description: "Learn from and contribute to community standards",
  },
];
---

<PageLayout meta={meta}>
  <h1 class="title mb-6">Studies</h1>

  <!-- Hero Section with CTAs -->
  <Section id="studies-cta">
    <div class="max-w-4xl mx-auto text-center mb-12">
      <p class="text-lg mb-8 text-color-600 dark:text-color-400">
        Advancing human-robot interaction through reproducible, collaborative
        research studies with shared protocols and open data.
      </p>

      <!-- CTA Buttons -->
      <div class="flex flex-wrap justify-center gap-4 mb-8">
        <a
          href="#browse"
          class="inline-flex items-center justify-center h-12 px-8 text-base font-semibold rounded-lg shadow-lg hover:brightness-110 transition-all gradient-brand-horizontal text-surface"
        >
          <Icon name="solar:eye-line-duotone" class="w-5 h-5 mr-2" />
          Browse Studies
        </a>
        <a
          href="/get-involved"
          class="inline-flex items-center justify-center h-12 px-8 text-base font-semibold rounded-lg border-2 border-accent-one hover:bg-accent-one/10 transition-all"
        >
          <Icon name="solar:add-square-line-duotone" class="w-5 h-5 mr-2" />
          Contribute Study
        </a>
      </div>

      <!-- Study Statistics -->
      {
        statistics && (
          <div class="flex flex-wrap justify-center gap-6 text-sm">
            <div class="flex items-center gap-2">
              <Icon
                name="solar:document-line-duotone"
                class="w-4 h-4 text-accent-one"
              />
              <span>{statistics.total} Studies</span>
            </div>
            <div class="flex items-center gap-2">
              <Icon
                name="solar:document-text-line-duotone"
                class="w-4 h-4 text-accent-two"
              />
              <span>{statistics.totalCitations} Citations</span>
            </div>
            <div class="flex items-center gap-2">
              <Icon
                name="solar:users-group-two-rounded-line-duotone"
                class="w-4 h-4 text-special"
              />
              <span>{statistics.uniqueAuthorsCount} Authors</span>
            </div>
            <div class="flex items-center gap-2">
              <Icon
                name="solar:buildings-line-duotone"
                class="w-4 h-4 text-green-500"
              />
              <span>{statistics.uniqueVenuesCount} Venues</span>
            </div>
          </div>
        )
      }
    </div>
  </Section>

  <!-- Study Types Overview -->
  {
    Object.keys(studyTypeCount).length > 0 && (
      <Section
        id="study-types"
        title="Study Types"
        subtitle="Diverse research outputs advancing HRI knowledge"
      >
        <div class="max-w-6xl mx-auto">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {Object.entries(studyTypeCount).map(([type, count]) => {
              const info = studyTypeInfo[type] || {
                title: type,
                icon: "solar:folder-line-duotone",
                description: `${count} studies available`,
              };

              return (
                <FeatureCard
                  icon={info.icon}
                  title={info.title}
                  description={`${count} ${count === 1 ? "Study" : "Studies"} • ${info.description}`}
                />
              );
            })}
          </div>
        </div>
      </Section>
    )
  }

  <!-- Services Section -->
  <Section
    id="services"
    title="Research Services"
    subtitle="Comprehensive support for conducting HRI studies"
  >
    <div class="max-w-5xl mx-auto">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        {
          services.map((service) => (
            <FeatureCard
              icon={service.icon}
              title={service.title}
              description={service.description}
            >
              <ul class="space-y-1">
                {service.features.map((feature) => (
                  <li class="flex items-center gap-2 text-xs">
                    <Icon
                      name="solar:check-circle-bold"
                      class="w-3 h-3 text-accent-one flex-shrink-0"
                    />
                    <span>{feature}</span>
                  </li>
                ))}
              </ul>
            </FeatureCard>
          ))
        }
      </div>
    </div>
  </Section>

  <!-- Research Areas Section -->
  {
    researchAreas.length > 0 && (
      <Section
        id="research-areas"
        title="Research Areas"
        subtitle="Key domains of HRI research represented in our collection"
      >
        <div class="max-w-5xl mx-auto">
          <div class="flex flex-wrap gap-3 justify-center">
            {researchAreas.map((area) => {
              const count = researchAreaCount[area] || 0;
              return (
                <a
                  href={`/studies/area/${area.toLowerCase().replace(/\s+/g, "-")}`}
                  class="inline-flex items-center gap-2 px-4 py-2 bg-special-lighter rounded-full border-2 hover:border-accent-two border-accent-one/40 transition-all text-sm"
                >
                  <span>{area}</span>
                  <span class="text-xs px-2 py-0.5 bg-accent-one/20 rounded-full">
                    {count}
                  </span>
                </a>
              );
            })}
          </div>
        </div>
      </Section>
    )
  }

  <!-- Featured Studies -->
  {
    featuredStudies.length > 0 && (
      <Section
        id="featured"
        title="Featured Studies"
        subtitle="Highlighted research making significant contributions to HRI"
      >
        <div class="max-w-6xl mx-auto">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {featuredStudies.slice(0, 6).map((study) => (
              <article class="group relative flex flex-col bg-special-lighter rounded-lg border-2 hover:border-accent-two border-accent-one/40 transition-all overflow-hidden">
                <div class="p-6 flex-1">
                  <div class="flex items-center gap-2 mb-3">
                    <span class="text-xs px-2 py-1 bg-accent-two/20 rounded">
                      {study.data.type}
                    </span>
                    <span class="text-xs text-color-600 dark:text-color-400">
                      {study.data.year}
                    </span>
                  </div>
                  <h3 class="font-semibold mb-2 line-clamp-2 group-hover:text-accent-one transition-colors">
                    {study.data.title}
                  </h3>
                  <p class="text-sm text-color-600 dark:text-color-400 line-clamp-3 mb-3">
                    {study.data.abstract}
                  </p>
                  <div class="flex items-center justify-between text-xs">
                    <span class="text-color-500">
                      {study.data.authors[0]?.name}
                      {study.data.authors.length > 1 && ` et al.`}
                    </span>
                    <div class="flex items-center gap-1">
                      <Icon
                        name="solar:document-text-line-duotone"
                        class="w-3 h-3"
                      />
                      <span>{study.data.citations}</span>
                    </div>
                  </div>
                </div>
                <a
                  href={`/studies/${study.id}`}
                  class="absolute inset-0"
                  aria-label={`Read more about ${study.data.title}`}
                />
              </article>
            ))}
          </div>
        </div>
      </Section>
    )
  }

  <!-- Recent Studies -->
  {
    recentStudies.length > 0 && (
      <Section
        id="recent"
        title="Recent Studies"
        subtitle="Latest research contributions to the HRI field"
      >
        <div class="max-w-4xl mx-auto">
          <div class="space-y-4">
            {recentStudies.map((study) => (
              <article class="group p-4 bg-special-lighter rounded-lg border-2 hover:border-accent-two border-accent-one/40 transition-all">
                <div class="flex items-start justify-between gap-4">
                  <div class="flex-1 min-w-0">
                    <h3 class="font-semibold mb-1 line-clamp-1 group-hover:text-accent-one transition-colors">
                      <a href={`/studies/${study.id}`}>{study.data.title}</a>
                    </h3>
                    <p class="text-sm text-color-600 dark:text-color-400 mb-2">
                      {study.data.authors.map((a) => a.name).join(", ")}
                    </p>
                    <div class="flex items-center gap-3 text-xs">
                      <span class="px-2 py-1 bg-accent-two/20 rounded">
                        {study.data.type}
                      </span>
                      <span>{study.data.year}</span>
                      {study.data.venue && (
                        <span class="text-color-500">{study.data.venue}</span>
                      )}
                    </div>
                  </div>
                  <div class="flex flex-col items-end gap-2 text-xs">
                    <div class="flex items-center gap-1 text-accent-one">
                      <Icon
                        name="solar:document-text-line-duotone"
                        class="w-3 h-3"
                      />
                      <span>{study.data.citations}</span>
                    </div>
                    <a
                      href={`/studies/${study.id}`}
                      class="text-link hover:underline"
                    >
                      View →
                    </a>
                  </div>
                </div>
              </article>
            ))}
          </div>
        </div>
      </Section>
    )
  }

  <!-- Browse All Studies -->
  <Section id="browse" title="Browse All Studies">
    <div class="max-w-4xl mx-auto text-center">
      <p class="mb-6 text-color-600 dark:text-color-400">
        Explore our complete collection of {allStudies.length} HRI research studies
      </p>
      <a
        href="/studies/all"
        class="inline-flex items-center justify-center h-12 px-8 text-base font-semibold rounded-lg shadow-lg hover:brightness-110 transition-all gradient-brand-horizontal text-surface"
      >
        <Icon name="solar:archive-line-duotone" class="w-5 h-5 mr-2" />
        View All Studies
      </a>
    </div>
  </Section>

  <!-- Benefits Section -->
  <Section
    id="benefits"
    title="Why Contribute?"
    subtitle="Benefits of sharing your research with the community"
  >
    <div class="max-w-5xl mx-auto">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        {
          benefits.map((benefit) => (
            <div class="flex items-start gap-4">
              <Icon
                name={benefit.icon}
                class="w-10 h-10 text-accent-two flex-shrink-0"
              />
              <div>
                <h3 class="font-semibold mb-1">{benefit.title}</h3>
                <p class="text-sm text-color-600 dark:text-color-400">
                  {benefit.description}
                </p>
              </div>
            </div>
          ))
        }
      </div>
    </div>
  </Section>

  <!-- Contribute Section -->
  <Section id="contribute">
    <div class="max-w-4xl mx-auto text-center">
      <h2 class="text-3xl font-bold mb-4">Contribute Your Research</h2>
      <p class="text-lg mb-8 text-color-600 dark:text-color-400">
        Share your studies, datasets, and research protocols with the HRI
        community. Help advance the field through open, reproducible science.
      </p>
      <div class="flex flex-wrap justify-center gap-4">
        <a
          href="/get-involved"
          class="inline-flex items-center justify-center h-12 px-8 text-base font-semibold rounded-lg shadow-lg hover:brightness-110 transition-all gradient-brand-horizontal text-surface"
        >
          <Icon name="solar:add-circle-line-duotone" class="w-5 h-5 mr-2" />
          Submit Your Study
        </a>
        <a
          href="/about"
          class="inline-flex items-center justify-center h-12 px-8 text-base font-semibold rounded-lg border-2 border-special hover:bg-special/10 transition-all"
        >
          <Icon name="solar:info-circle-line-duotone" class="w-5 h-5 mr-2" />
          Learn More
        </a>
      </div>
    </div>
  </Section>
</PageLayout>
