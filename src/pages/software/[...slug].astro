---
import { getCollection, getEntry } from "astro:content";
import BaseHead from "@/components/BaseHead.astro";
import SiteShell from "@/layouts/SiteShell.astro";
import {
  BaseDetailLayout,
  DetailHero,
  RelatedItemsGrid,
  ContentSection,
  SpecificationsList,
  FeaturesList,
  ChipsList,
} from "@/components/detail";
import LinkSection from "@/components/detail/LinkSection";
import BasicChip from "@/components/ui/BasicChip";
import { OrganizationChip } from "@/components/ui/OrganizationChip";
import { PersonPopover } from "@/components/people/PersonPopover";
import { getRelatedSoftware } from "@/data/software";
import { getPerson } from "@/data/people";
import { getStatusLabel, getStatusColor } from "@/config/statusConfig";
import { serializePersonForPopover } from "@/utils/person";
import { resolveLogoAsset } from "@/utils/images";

export async function getStaticPaths() {
  const software = await getCollection("software", ({ data }) => {
    return import.meta.env.PROD ? data.draft !== true : true;
  });
  return software.map((entry) => ({
    params: { slug: entry.id },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { data } = entry;

const relatedSoftware = await getRelatedSoftware(entry, 3);

const meta = {
  title: `${data.name} - Software Platform`,
  description: data.description,
};
const ogImage = `/og/software/${entry.id}.png`;

const badges = [
  data.status && {
    text: getStatusLabel(data.status),
    color: getStatusColor(data.status, "chip") as any,
    variant: "solid" as const,
  },
  data.license && {
    text: data.license,
    color: "blue" as const,
    variant: "outline" as const,
  },
].filter(Boolean) as Array<{
  text: string;
  color: "green" | "blue" | "orange" | "red" | "accent";
  variant: "solid" | "outline";
}>;

const contributors = data.contributors || [];
const peopleContributors = await Promise.all(
  contributors
    .filter((c) => c.type === "person")
    .map(async (contributor) => {
      const personEntry = await getPerson(contributor.personId);
      let currentAffiliation:
        | {
            organizationId: string;
            partnerName?: string;
            role: string;
          }
        | undefined;
      if (personEntry?.data?.affiliations) {
        const current = personEntry.data.affiliations.find(
          (aff) => !aff.endDate,
        );
        if (current) {
          const organization = await getEntry(
            "organizations",
            current.organizationId,
          );
          currentAffiliation = {
            organizationId: current.organizationId,
            partnerName: organization?.data.name || current.organizationId,
            role: current.role,
          };
        }
      }
      const person = serializePersonForPopover(personEntry);
      return {
        ...contributor,
        person,
        currentAffiliation,
      };
    }),
);
const validPeopleContributors = peopleContributors.filter(
  (c) => c.person !== null,
);

const orgContributors = await Promise.all(
  contributors
    .filter((c) => c.type === "organization")
    .map(async (contributor) => {
      const org = await getEntry("organizations", contributor.organizationId);
      return {
        ...contributor,
        data: org?.data,
      };
    }),
);

const primaryOrganization = orgContributors.find((c) => c.primary);
const supportingOrganizations = orgContributors.filter((c) => !c.primary);
const topics = data.topics ?? [];

const categoryLabels = {
  framework: "Framework",
  library: "Library",
  tool: "Tool",
  simulation: "Simulation",
  dataset: "Dataset",
  model: "Model",
};

const requirementItems: Array<{ label: string; value: string }> = [];
if (data.requirements) {
  if (data.requirements.runtime) {
    requirementItems.push({
      label: "Runtime",
      value: Array.isArray(data.requirements.runtime)
        ? data.requirements.runtime.join(", ")
        : data.requirements.runtime,
    });
  }
  if (data.requirements.hardware) {
    requirementItems.push({
      label: "Hardware",
      value: Array.isArray(data.requirements.hardware)
        ? data.requirements.hardware.join(", ")
        : data.requirements.hardware,
    });
  }
  if (data.requirements.dependencies) {
    requirementItems.push({
      label: "Dependencies",
      value: Array.isArray(data.requirements.dependencies)
        ? data.requirements.dependencies.join(", ")
        : data.requirements.dependencies,
    });
  }
}
---

<html
  class="overflow-x-hidden grid scroll-pt-[72px] scroll-smooth font-sans text-text text-xl md:text-base antialiased"
  lang="en"
>
  <head>
    <BaseHead
      title={meta.title}
      description={meta.description}
      ogImage={ogImage}
    />
  </head>
  <body class="relative min-h-screen w-full bg-surface">
    <SiteShell noPaddingTop showBackground containerClassName="max-w-5xl">
      <BaseDetailLayout>
        <Fragment slot="hero">
          <DetailHero
            image={data.images?.hero}
            title={data.name}
            subtitle={data.shortDescription}
            badges={badges}
            featuredState={data.featured ? "featured" : undefined}
            entityType="software"
            logo={resolveLogoAsset(data.images)}
          />
        </Fragment>

        <Fragment slot="links">
          {
            data.links && Object.keys(data.links).length > 0 && (
              <LinkSection
                client:idle
                links={data.links}
                size="md"
                className="gap-1"
              />
            )
          }
        </Fragment>

        <Fragment slot="description">
          <ContentSection title="DESCRIPTION" content={data.description} />
        </Fragment>

        <Fragment slot="contributors">
          {
            orgContributors.length > 0 || validPeopleContributors.length > 0 ? (
              <div class="bg-gradient-to-br from-surface-lighter to-surface rounded-xl border border-accent-one/20 p-6 backdrop-blur-lg">
                {orgContributors.length > 0 && (
                  <div class="organizations mb-6">
                    <h3 class="text-xs font-semibold mb-3 text-color-600 dark:text-color-400 uppercase tracking-wider">
                      ORGANIZATIONS
                    </h3>
                    <div class="flex flex-wrap gap-2">
                      {orgContributors.map((contributor) => (
                        <OrganizationChip
                          partnerId={contributor.organizationId}
                          partnerName={
                            contributor.data?.shortName ||
                            contributor.data?.name
                          }
                          logo={resolveLogoAsset(contributor.data?.images)}
                          role={contributor.role || "Contributing Organization"}
                        />
                      ))}
                    </div>
                  </div>
                )}

                {validPeopleContributors.length > 0 && (
                  <div class="people-contributors">
                    <h3 class="text-xs font-semibold mb-3 text-color-600 dark:text-color-400 uppercase tracking-wider">
                      CONTRIBUTORS
                    </h3>
                    <div class="flex flex-wrap gap-2">
                      {validPeopleContributors.map((contributor) => (
                        <PersonPopover
                          client:load
                          personId={contributor.personId}
                          person={contributor.person}
                          role={contributor.role}
                          currentAffiliation={contributor.currentAffiliation}
                        />
                      ))}
                    </div>
                  </div>
                )}

                <div class="mt-6 pt-4 border-t border-accent-one/10 flex flex-wrap gap-2">
                  {data.category && (
                    <BasicChip
                      text={
                        categoryLabels[
                          data.category as keyof typeof categoryLabels
                        ]
                      }
                      variant="tertiary"
                    />
                  )}
                  {data.language?.map((lang: string) => (
                    <BasicChip text={lang} variant="default" />
                  ))}
                </div>

                <div class="mt-6 pt-4 border-t border-accent-one/10 flex flex-wrap gap-6 text-xs text-color-600 dark:text-color-400">
                  {primaryOrganization && (
                    <div class="flex items-center gap-2">
                      <span class="font-semibold">Lead:</span>
                      <span>
                        {primaryOrganization.data?.shortName ||
                          primaryOrganization.data?.name ||
                          primaryOrganization.organizationId}
                      </span>
                    </div>
                  )}
                  {supportingOrganizations.length > 0 && (
                    <div class="flex items-center gap-2">
                      <span class="font-semibold">Supporting:</span>
                      <span>
                        {supportingOrganizations.length} org
                        {supportingOrganizations.length !== 1 ? "s" : ""}
                      </span>
                    </div>
                  )}
                  {validPeopleContributors.length > 0 && (
                    <div class="flex items-center gap-2">
                      <span class="font-semibold">Contributors:</span>
                      <span>
                        {validPeopleContributors.length}{" "}
                        {validPeopleContributors.length === 1
                          ? "person"
                          : "people"}
                      </span>
                    </div>
                  )}
                </div>
              </div>
            ) : null
          }
        </Fragment>

        <Fragment slot="specifications">
          {
            requirementItems.length > 0 && (
              <SpecificationsList
                title="SYSTEM REQUIREMENTS"
                items={requirementItems}
              />
            )
          }
        </Fragment>

        <Fragment slot="metadata">
          {
            (data.language?.length || data.platform?.length) && (
              <ChipsList
                title="TECHNOLOGIES"
                groups={(() => {
                  const groups: Array<{
                    title: string;
                    items: string[];
                    variant: "primary" | "secondary";
                  }> = [];
                  if (data.language?.length) {
                    groups.push({
                      title: "LANGUAGES",
                      items: data.language,
                      variant: "primary",
                    });
                  }
                  if (data.platform?.length) {
                    groups.push({
                      title: "PLATFORMS",
                      items: data.platform,
                      variant: "secondary",
                    });
                  }
                  return groups;
                })()}
              />
            )
          }
        </Fragment>

        <Fragment slot="features">
          {
            data.features && data.features.length > 0 && (
              <FeaturesList
                title="KEY FEATURES"
                features={data.features}
                featureIcon="solar:star-bold-duotone"
              />
            )
          }
        </Fragment>

        <Fragment slot="tags">
          {
            topics.length > 0 && (
              <ChipsList title="TOPICS" items={topics} variant="primary" />
            )
          }
        </Fragment>

        <Fragment slot="related">
          {
            relatedSoftware && relatedSoftware.length > 0 && (
              <RelatedItemsGrid
                client:load
                title="Related Software"
                subtitle="Discover similar tools and frameworks"
                items={relatedSoftware}
                itemType="software"
                columns={3}
              />
            )
          }
        </Fragment>
      </BaseDetailLayout>
    </SiteShell>
  </body>
</html>
