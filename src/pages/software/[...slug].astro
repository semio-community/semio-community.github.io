---
import { getCollection, getEntry } from "astro:content";
import BaseHead from "@/components/BaseHead.astro";
import SiteShell from "@/layouts/SiteShell.astro";
import { getRelatedSoftware } from "@/data/software";
import { getPerson } from "@/data/people";
import { serializePersonForPopover } from "@/utils/person";
import { SoftwareDetail } from "@/components/detail/views/SoftwareDetail";

export async function getStaticPaths() {
  const software = await getCollection("software", ({ data }) => {
    return import.meta.env.PROD ? data.draft !== true : true;
  });
  return software.map((entry) => ({
    params: { slug: entry.id },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { data } = entry;

const relatedSoftware = await getRelatedSoftware(entry, 3);

const meta = {
  title: `${data.name} - Software Platform`,
  description: data.description,
};
const ogImage = `/og/software/${entry.id}.png`;

const contributors = data.contributors || [];
const peopleContributors = await Promise.all(
  contributors
    .filter((c) => c.type === "person")
    .map(async (contributor) => {
      const personEntry = await getPerson(contributor.personId);
      let currentAffiliation:
        | {
            organizationId: string;
            partnerName?: string;
            role: string;
          }
        | undefined;
      if (personEntry?.data?.affiliations) {
        const current = personEntry.data.affiliations.find(
          (aff) => !aff.endDate,
        );
        if (current) {
          const organization = await getEntry(
            "organizations",
            current.organizationId,
          );
          currentAffiliation = {
            organizationId: current.organizationId,
            partnerName: organization?.data.name || current.organizationId,
            role: current.role,
          };
        }
      }
      const person = serializePersonForPopover(personEntry);
      return {
        ...contributor,
        person,
        currentAffiliation,
      };
    }),
);
const validPeopleContributors = peopleContributors.filter(
  (c) => c.person !== null,
);

const orgContributors = await Promise.all(
  contributors
    .filter((c) => c.type === "organization")
    .map(async (contributor) => {
      const org = await getEntry("organizations", contributor.organizationId);
      return {
        ...contributor,
        data: org?.data,
      };
    }),
);
---

<html
  class="overflow-x-hidden grid scroll-pt-[72px] scroll-smooth font-sans text-text text-xl md:text-base antialiased"
  lang="en"
>
  <head>
    <BaseHead
      title={meta.title}
      description={meta.description}
      ogImage={ogImage}
    />
  </head>
  <body class="relative min-h-screen w-full bg-surface">
    <SiteShell noPaddingTop showBackground containerClassName="max-w-5xl">
      <SoftwareDetail
        data={data}
        organizationContributors={orgContributors}
        peopleContributors={validPeopleContributors}
        relatedSoftware={relatedSoftware}
      />
    </SiteShell>
  </body>
</html>
