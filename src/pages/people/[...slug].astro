---
import { type CollectionEntry, getCollection, getEntry } from "astro:content";
import BaseHead from "@/components/BaseHead.astro";
import SiteShell from "@/layouts/SiteShell.astro";
import {
  BaseDetailLayout,
  DetailHero,
  ContentSection,
  InfoCard,
} from "@/components/detail";
import { RelatedItemsGrid } from "@/components/detail/RelatedItemsGrid";
import { ResearchCard } from "@/components/cards/ResearchCard";
import { HardwareCard } from "@/components/cards/HardwareCard";
import { SoftwareCard } from "@/components/cards/SoftwareCard";
import { EventCard } from "@/components/cards/EventCard";
import { getPeopleByExpertise, getPeopleByOrganization } from "@/data/people";
import { getAllResearch } from "@/data/research";
import { getAllHardware } from "@/data/hardware";
import { getAllSoftware } from "@/data/software";
import { OrganizationChip } from "@/components/ui/OrganizationChip";
import LinkSection from "@/components/detail/LinkSection";
import { resolveLogoAsset } from "@/utils/images";

export async function getStaticPaths() {
  const people = await getCollection("people", ({ data }) => {
    // In production, exclude drafts and private people. In development, show all.
    return import.meta.env.PROD ? data.draft !== true : true;
  });
  return people.map((entry) => ({
    params: { slug: entry.id },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { data } = entry;
const fullName = data.honorific ? `${data.honorific} ${data.name}` : data.name;

// Get related people (by expertise or organization)
async function getRelatedPeople(
  person: CollectionEntry<"people">,
  limit: number = 3,
) {
  const relatedPeople: CollectionEntry<"people">[] = [];
  const seenIds = new Set<string>([person.id]);

  // Find people with similar expertise
  if (person.data.expertise && person.data.expertise.length > 0) {
    for (const expertise of person.data.expertise.slice(0, 2)) {
      const expertisePeople = await getPeopleByExpertise(expertise);
      for (const p of expertisePeople) {
        if (!seenIds.has(p.id) && relatedPeople.length < limit) {
          relatedPeople.push(p);
          seenIds.add(p.id);
        }
      }
    }
  }

  // If not enough, find people from same organization
  if (
    relatedPeople.length < limit &&
    person.data.affiliations &&
    person.data.affiliations.length > 0
  ) {
    const currentAffiliations = person.data.affiliations.filter(
      (aff) => !aff.endDate,
    );
    for (const aff of currentAffiliations) {
      const orgPeople = await getPeopleByOrganization(aff.organizationId);
      for (const p of orgPeople) {
        if (!seenIds.has(p.id) && relatedPeople.length < limit) {
          relatedPeople.push(p);
          seenIds.add(p.id);
        }
      }
    }
  }

  return relatedPeople.slice(0, limit);
}

const relatedPeople = await getRelatedPeople(entry, 3);

// Get related content by this person
async function getPersonRelatedContent(personId: string) {
  // Get research where this person is an author
  const allResearch = await getAllResearch();
  const research = allResearch.filter((study) =>
    study.data.contributors?.some(
      (contributor) => contributor.personId === personId,
    ),
  );

  // Get hardware where this person is a contributor
  const allHardware = await getAllHardware();
  const hardware = allHardware.filter((hw) =>
    hw.data.contributors?.some(
      (contributor) =>
        contributor.type === "person" && contributor.personId === personId,
    ),
  );

  // Get software where this person is a contributor
  const allSoftware = await getAllSoftware();
  const software = allSoftware.filter((sw) =>
    sw.data.contributors?.some(
      (contributor) =>
        contributor.type === "person" && contributor.personId === personId,
    ),
  );

  // Events are tracked at the Semio-community level; per-person associations
  // are not available in the simplified roles schema.
  const events: CollectionEntry<"events">[] = [];

  return { research, hardware, software, events };
}

const relatedContent = await getPersonRelatedContent(entry.id);

const meta = {
  title: `${fullName} - Researcher Profile`,
  description: data.bio || `Profile of ${fullName}`,
};
const ogImage = `/og/people/${entry.id}.png`;

// Prepare status badges
const badges = [];
if (data.pronouns) {
  badges.push({
    text: data.pronouns,
    color: "gray" as const,
    variant: "outline" as const,
  });
}

// Prepare action buttons
const actionButtons = [];
if (data.links?.website) {
  actionButtons.push({
    href: data.links?.website,
    text: "Personal Website",
    variant: "default" as const,
    target: "_blank",
    rel: "noopener noreferrer",
    icon: "solar:global-line-duotone",
  });
}
if (data.links?.github) {
  actionButtons.push({
    href: `https://github.com/${data.links.github}`,
    text: "GitHub",
    variant: "secondary" as const,
    target: "_blank",
    rel: "noopener noreferrer",
    icon: "mdi:github",
  });
}
if (data.links?.email) {
  actionButtons.push({
    href: `mailto:${data.links.email}`,
    text: "Email",
    variant: "tertiary" as const,
    icon: "solar:letter-line-duotone",
  });
}
if (data.links?.linkedin) {
  actionButtons.push({
    href: `https://linkedin.com/in/${data.links.linkedin}`,
    text: "LinkedIn",
    variant: "tertiary" as const,
    target: "_blank",
    rel: "noopener noreferrer",
    icon: "mdi:linkedin",
  });
}
if (data.links?.twitter) {
  actionButtons.push({
    href: `https://twitter.com/${data.links.twitter}`,
    text: "Twitter",
    variant: "tertiary" as const,
    target: "_blank",
    rel: "noopener noreferrer",
    icon: "mdi:twitter",
  });
}
if (data.links?.mastodon) {
  actionButtons.push({
    href: `https://mastodon.com/${data.links.mastodon}`,
    text: "Mastodon",
    variant: "tertiary" as const,
    target: "_blank",
    rel: "noopener noreferrer",
    icon: "mdi:mastodon",
  });
}
if (data.links?.scheduling) {
  actionButtons.push({
    href: data.links?.scheduling,
    text: "Schedule",
    variant: "default" as const,
    target: "_blank",
    rel: "noopener noreferrer",
    icon: "solar:calendar-mark-line-duotone",
  });
}

// Prepare affiliations for display in main content
const currentAffiliations = await Promise.all(
  (data.affiliations || [])
    .filter((aff) => !aff.endDate)
    .map(async (aff) => {
      const org = await getEntry("organizations", aff.organizationId);
      return {
        ...aff,
        organization: org,
      };
    }),
);

const pastAffiliations = await Promise.all(
  (data.affiliations || [])
    .filter((aff) => aff.endDate)
    .map(async (aff) => {
      const org = await getEntry("organizations", aff.organizationId);
      return {
        ...aff,
        organization: org,
      };
    }),
);

// Prepare academic profile items
const academicProfileItems = [];
if (data.links?.orcid) {
  academicProfileItems.push({
    label: "ORCID",
    value: data.links.orcid,
    link: `https://orcid.org/${data.links.orcid}`,
    external: true,
  });
}
if (data.links?.googleScholar) {
  academicProfileItems.push({
    label: "Google Scholar",
    value: "View Profile",
    link: `https://scholar.google.com/citations?user=${data.links.googleScholar}`,
    external: true,
  });
}

// Prepare social media items
const socialMediaItems = [];
if (data.links?.twitter) {
  socialMediaItems.push({
    label: "Twitter",
    value: `@${data.links.twitter}`,
    link: `https://twitter.com/${data.links.twitter}`,
    external: true,
  });
}
if (data.links?.bluesky) {
  socialMediaItems.push({
    label: "Bluesky",
    value: data.links.bluesky,
    link: `https://bsky.app/profile/${data.links.bluesky}`,
    external: true,
  });
}
if (data.links?.mastodon) {
  socialMediaItems.push({
    label: "Mastodon",
    value: data.links.mastodon,
    link: data.links.mastodon,
    external: true,
  });
}
---

<html
  class="overflow-x-hidden grid scroll-pt-[72px] scroll-smooth font-sans text-text text-xl md:text-base antialiased"
  lang="en"
>
  <head>
    <BaseHead
      title={meta.title}
      description={meta.description}
      ogImage={ogImage}
    />
  </head>
  <body class="relative min-h-screen w-full bg-surface">
    <SiteShell noPaddingTop showBackground containerClassName="max-w-5xl">
      <BaseDetailLayout>
        <Fragment slot="hero">
          <DetailHero
            image={data.images?.hero}
            title={fullName}
            subtitle={data.title}
            badges={badges}
            featuredState={data.featured ? "featured" : undefined}
            avatar={data.images?.avatar}
            entityType="person"
            logoText={data.name}
          />
        </Fragment>

        <Fragment slot="contributors">
          {
            (currentAffiliations.length > 0 || pastAffiliations.length > 0) && (
              <InfoCard title="AFFILIATIONS">
                {currentAffiliations.length > 0 && (
                  <div class="mb-4">
                    <h4 class="text-xs font-medium mb-2 text-color-600 dark:text-color-400">
                      Current
                    </h4>
                    <div class="flex flex-wrap gap-2">
                      {currentAffiliations.map((aff) => (
                        <OrganizationChip
                          partnerId={aff.organizationId}
                          partnerName={
                            aff.organization?.data?.shortName ||
                            aff.organization?.data?.name
                          }
                          logo={resolveLogoAsset(
                            aff.organization?.data?.images,
                          )}
                          role={
                            aff.department
                              ? `${aff.role}, ${aff.department}`
                              : aff.role
                          }
                        />
                      ))}
                    </div>
                  </div>
                )}

                {pastAffiliations.length > 0 && (
                  <div>
                    <h4 class="text-xs font-medium mb-2 text-color-600 dark:text-color-400">
                      Past
                    </h4>
                    <div class="flex flex-wrap gap-2">
                      {pastAffiliations.map((aff) => (
                        <OrganizationChip
                          partnerId={aff.organizationId}
                          partnerName={
                            aff.organization?.data?.shortName ||
                            aff.organization?.data?.name
                          }
                          logo={resolveLogoAsset(
                            aff.organization?.data?.images,
                          )}
                          role={
                            aff.department
                              ? `${aff.role}, ${aff.department}`
                              : aff.role
                          }
                        />
                      ))}
                    </div>
                  </div>
                )}
              </InfoCard>
            )
          }
        </Fragment>

        <Fragment slot="links">
          {
            data.links && Object.keys(data.links).length > 0 && (
              <LinkSection
                client:idle
                links={data.links}
                size="md"
                className="gap-1"
              />
            )
          }
        </Fragment>

        <Fragment slot="tags">
          {
            data.expertise && data.expertise.length > 0 && (
              <InfoCard title="EXPERTISE AREAS">
                <div class="flex flex-wrap gap-2">
                  {data.expertise.map((skill) => (
                    <span class="px-3 py-1.5 bg-accent-one/10 rounded-lg text-sm text-accent-base">
                      {skill}
                    </span>
                  ))}
                </div>
              </InfoCard>
            )
          }
        </Fragment>

        <Fragment slot="description">
          <ContentSection title="BIOGRAPHY" content={data.bio} />
        </Fragment>

        <Fragment slot="related">
          {
            (relatedContent.research.length > 0 ||
              relatedContent.hardware.length > 0 ||
              relatedContent.software.length > 0 ||
              relatedContent.events.length > 0) && (
              <div class="mt-12">
                <h2 class="text-2xl font-bold mb-2">
                  Contributions &amp; Involvement
                </h2>
                <p class="text-color-600 dark:text-color-400 mb-8">
                  Research, projects, and events
                </p>

                {relatedContent.research.length > 0 && (
                  <div class="mb-12">
                    <h3 class="text-lg font-semibold mb-4">Research</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                      {relatedContent.research.map((item) => (
                        <ResearchCard researchId={item.id} data={item.data} />
                      ))}
                    </div>
                  </div>
                )}

                {relatedContent.hardware.length > 0 && (
                  <div class="mb-12">
                    <h3 class="text-lg font-semibold mb-4">Hardware</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                      {relatedContent.hardware.map((hw) => (
                        <HardwareCard hardwareId={hw.id} data={hw.data} />
                      ))}
                    </div>
                  </div>
                )}

                {relatedContent.software.length > 0 && (
                  <div class="mb-12">
                    <h3 class="text-lg font-semibold mb-4">Software</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                      {relatedContent.software.map((sw) => (
                        <SoftwareCard softwareId={sw.id} data={sw.data} />
                      ))}
                    </div>
                  </div>
                )}

                {relatedContent.events.length > 0 && (
                  <div class="mb-12">
                    <h3 class="text-lg font-semibold mb-4">Events</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                      {relatedContent.events.map((event) => (
                        <EventCard eventId={event.id} data={event.data} />
                      ))}
                    </div>
                  </div>
                )}
              </div>
            )
          }

          {
            relatedPeople && relatedPeople.length > 0 && (
              <div class="mt-12">
                <RelatedItemsGrid
                  client:load
                  title="Related Researchers"
                  subtitle="Researchers with similar expertise or affiliations"
                  items={relatedPeople.map((person) => ({
                    id: person.id,
                    data: {
                      ...person.data,
                      name: person.data.honorific
                        ? `${person.data.honorific} ${person.data.name}`
                        : person.data.name,
                      description: person.data.bio || person.data.title || "",
                      shortDescription: person.data.title || "",
                      images: person.data.images,
                      featured: person.data.featured,
                    },
                  }))}
                  itemType="people"
                  columns={3}
                />
              </div>
            )
          }
        </Fragment>
      </BaseDetailLayout>
    </SiteShell>
  </body>
</html>
